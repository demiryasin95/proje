@{
    ViewBag.Title = "Ders Saatleri";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<!-- Page Header -->
<div class="d-flex align-items-center justify-content-between mb-4 fade-in">
    <div>
        <h1 class="h3 mb-0 text-main fw-bold">
            <i class="fas fa-clock me-2 text-primary"></i>Ders Saatleri
        </h1>
        <p class="text-secondary mb-0">Ders saatlerini tanımlayın, düzenleyin ve yönetin</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSlotModal">
            <i class="fas fa-plus me-2"></i>Yeni Ders Saati
        </button>
    </div>
</div>

<!-- Search and Filter -->
<div class="card mb-4 fade-in">
    <div class="card-header d-flex align-items-center justify-content-between">
        <h6 class="m-0 fw-bold text-primary">
            <i class="fas fa-filter me-2"></i>Arama ve Filtreleme
        </h6>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text bg-transparent border-end-0">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control border-start-0 ps-0" id="slotSearch" placeholder="Ders saati ara...">
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="slotPageSize">
                    <option value="5">5 Kayıt</option>
                    <option value="10" selected>10 Kayıt</option>
                    <option value="25">25 Kayıt</option>
                    <option value="50">50 Kayıt</option>
                </select>
            </div>
            <div class="col-md-3 d-flex gap-2">
                <button class="btn btn-outline-secondary w-100" id="refreshBtn" title="Yenile">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="btn btn-outline-danger w-100" id="clearFilterBtn" title="Filtreleri Temizle">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Time Slots Table -->
<div class="card fade-in">
    <div class="card-header d-flex align-items-center justify-content-between">
        <h6 class="m-0 fw-bold text-primary">
            <i class="fas fa-list me-2"></i>Ders Saatleri Listesi
        </h6>
        <span class="badge bg-primary rounded-pill" id="slotTotalInfo">
            Yükleniyor...
        </span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="timeSlotsTable">
                <thead class="bg-light text-muted small fw-bold text-uppercase">
                    <tr>
                        <th>Ad</th>
                        <th>Başlangıç</th>
                        <th>Bitiş</th>
                        <th>Teneffüs</th>
                        <th>Öğle</th>
                        <th class="text-end">İşlemler</th>
                    </tr>
                </thead>
                <tbody id="timeSlotsTableBody">
                    <!-- Loading State -->
                    <tr id="loadingState" style="display: none;">
                        <td colspan="6" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Yükleniyor...</span>
                            </div>
                            <p class="text-muted mt-3 mb-0">Ders saatleri yükleniyor...</p>
                        </td>
                    </tr>
                    <!-- Empty State -->
                    <tr id="emptyState" style="display: none;">
                        <td colspan="6" class="text-center py-5">
                            <i class="fas fa-clock fa-3x text-muted mb-3 d-block"></i>
                            <h5 class="text-muted">Henüz ders saati tanımlanmamış</h5>
                            <p class="text-muted small mb-3">Yeni bir ders saati ekleyerek başlayın</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSlotModal">
                                <i class="fas fa-plus me-2"></i>İlk Ders Saatini Ekle
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center px-4 py-3 border-top">
            <div id="slotPageInfo" class="text-muted small"></div>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" id="slotPrevPage">
                    <i class="fas fa-chevron-left me-1"></i>Önceki
                </button>
                <button class="btn btn-sm btn-outline-primary" id="slotNextPage">
                    Sonraki<i class="fas fa-chevron-right ms-1"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Time Slot Modal -->
<div class="modal fade" id="addSlotModal" tabindex="-1" aria-labelledby="addSlotModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0" style="background: linear-gradient(135deg, #5E72E4 0%, #825EE4 100%);">
                <h5 class="modal-title fw-bold" id="addSlotModalLabel" style="color: white !important;">
                    <i class="fas fa-plus-circle me-2"></i>Yeni Ders Saati
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body p-4">
                <form id="addSlotForm">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-tag me-2 text-primary"></i>Ders Saati Adı
                        </label>
                        <input type="text" class="form-control melody-form-control" name="Name" placeholder="Örn: 1. Ders" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-clock me-2 text-success"></i>Başlangıç Saati
                            </label>
                            <input type="time" class="form-control melody-form-control" name="StartTime" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-clock me-2 text-danger"></i>Bitiş Saati
                            </label>
                            <input type="time" class="form-control melody-form-control" name="EndTime" required>
                        </div>
                    </div>
                    <div class="mb-3 p-3 bg-light rounded">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="addIsBreak" name="IsBreak" style="cursor: pointer;">
                            <label class="form-check-label fw-semibold" for="addIsBreak" style="cursor: pointer;">
                                <i class="fas fa-coffee me-2 text-warning"></i>Teneffüs Saati
                            </label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="addIsLunch" name="IsLunch" style="cursor: pointer;">
                            <label class="form-check-label fw-semibold" for="addIsLunch" style="cursor: pointer;">
                                <i class="fas fa-utensils me-2 text-info"></i>Öğle Arası
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary rounded-pill px-4 shadow-sm" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>İptal
                </button>
                <button type="button" class="btn btn-primary melody-btn rounded-pill px-4 shadow-sm" id="saveSlotBtn">
                    <i class="fas fa-check me-2"></i>Kaydet
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Time Slot Modal -->
<div class="modal fade" id="editSlotModal" tabindex="-1" aria-labelledby="editSlotModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0" style="background: linear-gradient(135deg, #5E72E4 0%, #825EE4 100%);">
                <h5 class="modal-title fw-bold" id="editSlotModalLabel" style="color: white !important;">
                    <i class="fas fa-edit me-2"></i>Ders Saati Düzenle
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body p-4">
                <form id="editSlotForm">
                    <input type="hidden" name="Id" id="editId">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-tag me-2 text-primary"></i>Ders Saati Adı
                        </label>
                        <input type="text" class="form-control melody-form-control" name="Name" id="editName" placeholder="Örn: 1. Ders" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-clock me-2 text-success"></i>Başlangıç Saati
                            </label>
                            <input type="time" class="form-control melody-form-control" name="StartTime" id="editStart" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-clock me-2 text-danger"></i>Bitiş Saati
                            </label>
                            <input type="time" class="form-control melody-form-control" name="EndTime" id="editEnd" required>
                        </div>
                    </div>
                    <div class="mb-3 p-3 bg-light rounded">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="editIsBreak" name="IsBreak" style="cursor: pointer;">
                            <label class="form-check-label fw-semibold" for="editIsBreak" style="cursor: pointer;">
                                <i class="fas fa-coffee me-2 text-warning"></i>Teneffüs Saati
                            </label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="editIsLunch" name="IsLunch" style="cursor: pointer;">
                            <label class="form-check-label fw-semibold" for="editIsLunch" style="cursor: pointer;">
                                <i class="fas fa-utensils me-2 text-info"></i>Öğle Arası
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary rounded-pill px-4 shadow-sm" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>İptal
                </button>
                <button type="button" class="btn btn-primary melody-btn rounded-pill px-4 shadow-sm" id="updateSlotBtn">
                    <i class="fas fa-save me-2"></i>Güncelle
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete TimeSlot Confirmation Modal -->
<div class="modal fade" id="deleteTimeSlotModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                <h5 class="modal-title" style="color: white !important;">
                    <i class="fas fa-exclamation-triangle me-2"></i>Ders Saati Silme Onayı
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" id="deleteTimeSlotId">
                <div class="text-center mb-3">
                    <i class="fas fa-clock fa-3x text-danger mb-3"></i>
                    <p class="mb-2 fs-5">Bu ders saatini silmek istediğinizden emin misiniz?</p>
                    <p class="text-muted small mb-0">Bu işlem geri alınamaz.</p>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary rounded-pill px-4 shadow-sm" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>İptal
                </button>
                <button type="button" class="btn btn-danger rounded-pill px-4 shadow-sm" id="confirmDeleteTimeSlotBtn">
                    <i class="fas fa-trash me-2"></i>Evet, Sil
                </button>
            </div>
        </div>
    </div>
</div>

<style></style>
@section scripts {
    <script>
        function melodyHas(fn){ return window.MelodyTheme && typeof window.MelodyTheme[fn] === 'function'; }
        function toast(msg, type){
            if (melodyHas('showToast')) { window.MelodyTheme.showToast(msg, type); }
            else { if (typeof window.showAlert === 'function') window.showAlert(msg, type === 'error' ? 'danger' : (type || 'info')); }
        }

        function loadTimeSlots(){
            var $body = $('#timeSlotsTableBody');
            $body.find('.time-slot-row').remove();

            // Show loading state
            $('#loadingState').show();
            $('#emptyState').hide();

            $.get('/Admin/GetTimeSlots', function (res) {
                // Hide loading state
                $('#loadingState').hide();
                $body.find('.time-slot-row').remove();

                var slots = (res && res.success && Array.isArray(res.timeSlots)) ? res.timeSlots : [];
                if (slots.length === 0) {
                    $('#emptyState').show();
                    $('#slotTotalInfo').text('Henüz ders saati yok');
                    $('#slotPageInfo').text('');
                    return;
                }

                // Hide empty state and show data
                $('#emptyState').hide();
                $('#slotTotalInfo').text('TOPLAM ' + slots.length + ' KAYIT BULUNDU');

                // Populate table
                slots.forEach(function (t) {
                    var br = t.isBreak ? '<span class="badge rounded-pill bg-warning">Teneffüs</span>' : '';
                    var ln = t.isLunch ? '<span class="badge rounded-pill bg-info">Öğle</span>' : '';
                    $body.append(
                        `<tr class="time-slot-row">
                            <td>${t.name}</td>
                            <td>${t.startTime}</td>
                            <td>${t.endTime}</td>
                            <td>${br}</td>
                            <td>${ln}</td>
                            <td>
                                <button class="btn btn-sm btn-icon btn-indigo rounded-3 shadow-sm me-1 btn-edit-slot" data-id="${t.id}" data-name="${t.name}" data-start="${t.startTime}" data-end="${t.endTime}" data-break="${t.isBreak}" data-lunch="${t.isLunch}" title="Düzenle"><i class="fas fa-edit text-white"></i></button>
                                <button class="btn btn-sm btn-icon btn-danger rounded-3 shadow-sm btn-delete-slot" data-id="${t.id}" title="Sil"><i class="fas fa-trash text-white"></i></button>
                            </td>
                         </tr>`
                    );
                });
                applySearchAndPaginate();
            }).fail(function () {
                $('#loadingState').hide();
                $body.find('.time-slot-row').remove();
                $('#emptyState').show();
                $('#slotTotalInfo').text('Henüz ders saati yok');
                $('#slotPageInfo').text('');
                toast('Ders saati listesi yuklenemedi', 'error');
            });
        }

        function applySearchAndPaginate(){
            var term = ($('#slotSearch').val()||'').toLowerCase();
            var size = parseInt($('#slotPageSize').val(),10)||10;
            var rows = $('#timeSlotsTableBody .time-slot-row');
            var filtered = [];
            rows.each(function(){
                var t = $(this).text().toLowerCase();
                var match = term.length<1 || t.indexOf(term)>=0;
                $(this).toggle(match);
                if(match) filtered.push(this);
            });
            var total = filtered.length;
            var pages = Math.max(1, Math.ceil(total/size));
            window.slotCurrentPage = window.slotCurrentPage || 1;
            if(window.slotCurrentPage>pages) window.slotCurrentPage = pages;
            filtered.forEach(function(row, idx){
                var show = idx >= (window.slotCurrentPage-1)*size && idx < window.slotCurrentPage*size;
                $(row).toggle(show);
            });
            $('#slotPageInfo').text('Sayfa '+window.slotCurrentPage+' / '+pages+' • Toplam '+total+' kayıt');
        }

        $(function () {
            loadTimeSlots();
            $('#slotSearch, #slotPageSize').on('input change', function(){ window.slotCurrentPage=1; applySearchAndPaginate(); });
            $('#slotPrevPage').on('click', function(){ if((window.slotCurrentPage||1)>1){ window.slotCurrentPage--; applySearchAndPaginate(); } });
            $('#slotNextPage').on('click', function(){ window.slotCurrentPage=(window.slotCurrentPage||1)+1; applySearchAndPaginate(); });

            $('#saveSlotBtn').on('click', function(){
                var fd = $('#addSlotForm').serialize();
                $.post('/Admin/AddTimeSlot', fd, function(res){
                    if(res && res.success){
                        (bootstrap.Modal.getInstance(document.getElementById('addSlotModal')) || new bootstrap.Modal(document.getElementById('addSlotModal'))).hide();
                        $('#addSlotForm')[0].reset();
                        loadTimeSlots();
                        toast('Ders saati eklendi', 'success');
                    } else {
                        toast(res.message || 'Kayıt sırasında hata', 'error');
                    }
                }).fail(function(){ alert('Kayıt isteği başarısız oldu'); });
            });

            $(document).on('click', '.btn-edit-slot', function(){
                var $el = $(this);
                $('#editId').val($el.data('id'));
                $('#editName').val($el.data('name'));
                $('#editStart').val($el.data('start'));
                $('#editEnd').val($el.data('end'));
                $('#editIsBreak').prop('checked', String($el.data('break'))==='true');
                $('#editIsLunch').prop('checked', String($el.data('lunch'))==='true');
                new bootstrap.Modal(document.getElementById('editSlotModal')).show();
            });

            $('#updateSlotBtn').on('click', function(){
                var fd = $('#editSlotForm').serialize();
                $.post('/Admin/UpdateTimeSlot', fd, function(res){
                    if(res && res.success){
                        (bootstrap.Modal.getInstance(document.getElementById('editSlotModal')) || new bootstrap.Modal(document.getElementById('editSlotModal'))).hide();
                        loadTimeSlots();
                        toast('Ders saati güncellendi', 'success');
                    } else {
                        toast(res.message || 'Güncelleme sırasında hata', 'error');
                    }
                }).fail(function(){ alert('Güncelleme isteği başarısız oldu'); });
            });

            $(document).on('click', '.btn-delete-slot', function(){
                var id = $(this).data('id');
                $('#deleteTimeSlotId').val(id);
                new bootstrap.Modal(document.getElementById('deleteTimeSlotModal')).show();
            });

            // Confirm delete button
            $('#confirmDeleteTimeSlotBtn').on('click', function(){
                var id = parseInt($('#deleteTimeSlotId').val(), 10);
                if (!id) return;

                // Close modal
                var modal = bootstrap.Modal.getInstance(document.getElementById('deleteTimeSlotModal'));
                if (modal) modal.hide();

                toast('Ders saati siliniyor...', 'info');
                
                $.post('/Admin/DeleteTimeSlot', { id: id }, function(res){
                    if(res && res.success){
                        toast('Ders saati silindi', 'success');
                        loadTimeSlots();
                    } else {
                        toast(res.message || 'Silme sırasında hata', 'error');
                    }
                }).fail(function(){ toast('Silme isteği başarısız oldu', 'error'); });
            });
        });
    </script>
}
