@model StudentStudyProgram.Models.PushNotificationViewModel
@{
    ViewBag.Title = "Push Bildirim Yönetimi";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<!-- Page Header with Melody Theme -->
<div class="d-sm-flex align-items-center justify-content-between mb-4 melody-fade-in">
    <div>
        <h1 class="h3 mb-0 melody-text-gradient">
            <i class="fas fa-bell me-2"></i>Push Bildirim Yönetimi
        </h1>
        <p class="text-muted mb-0 small">Kullanıcılara anlık bildirim gönderin, abonelikleri yönetin</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-primary melody-btn melody-shadow-sm" data-bs-toggle="modal" data-bs-target="#sendNotificationModal">
            <i class="fas fa-paper-plane me-2"></i>Bildirim Gönder
        </button>
        <button class="btn btn-outline-warning melody-btn" id="testSubscriptionBtn" title="Abonelik Test Et">
            <i class="fas fa-vial me-2"></i>Test
        </button>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4 melody-fade-in">
    <div class="col-md-4">
        <div class="card stats-card melody-card border-0 mb-3">
            <div class="position-relative z-1">
                <div class="stats-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stats-number" id="activeSubsCount">@Model.TotalActiveSubscriptions</div>
                <div class="stats-label">Aktif Abonelik</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card melody-card border-0 mb-3" style="background: linear-gradient(135deg, #11CDEF 0%, #1171ef 100%); color: white; position: relative; overflow: hidden;">
            <div class="position-relative z-1">
                <div class="stats-icon">
                    <i class="fas fa-envelope"></i>
                </div>
                <div class="stats-number" id="totalSentCount">@Model.TotalNotificationsSent</div>
                <div class="stats-label">Toplam Gönderilen</div>
            </div>
            <div class="position-absolute top-0 end-0 opacity-25" style="transform: translate(25%, -25%);">
                <i class="fas fa-paper-plane fa-5x"></i>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card melody-card border-0 mb-3" style="background: linear-gradient(135deg, #F5365C 0%, #FB6340 100%); color: white; position: relative; overflow: hidden;">
            <div class="position-relative z-1">
                <div class="stats-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stats-number" id="successRate">%</div>
                <div class="stats-label">Başarı Oranı</div>
            </div>
            <div class="position-absolute top-0 end-0 opacity-25" style="transform: translate(25%, -25%);">
                <i class="fas fa-trophy fa-5x"></i>
            </div>
        </div>
    </div>
</div>

<!-- Tabs for Subscriptions and Logs -->
<div class="row mb-4 melody-slide-in">
    <div class="col-12">
        <div class="card melody-card melody-shadow-lg border-0">
            <div class="card-header bg-gradient-primary text-white py-3">
                <ul class="nav nav-tabs card-header-tabs nav-fill" id="notificationTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active text-white" id="subs-tab" data-bs-toggle="tab" data-bs-target="#subscriptions-tab-pane" type="button" role="tab">
                            <i class="fas fa-users me-2"></i>Abonelikler
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link text-white" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs-tab-pane" type="button" role="tab">
                            <i class="fas fa-history me-2"></i>Gönderim Geçmişi
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body p-0">
                <div class="tab-content" id="notificationTabContent">
                    <!-- Subscriptions Tab -->
                    <div class="tab-pane fade show active" id="subscriptions-tab-pane" role="tabpanel">
                        <div class="table-responsive melody-table-responsive">
                            <table class="table melody-table table-hover mb-0" id="subscriptionsTable">
                                <thead class="melody-table-header">
                                    <tr>
                                        <th width="60" class="text-center">
                                            <i class="fas fa-image"></i>
                                        </th>
                                        <th>
                                            <i class="fas fa-user me-1"></i>Kullanıcı
                                        </th>
                                        <th>
                                            <i class="fas fa-envelope me-1"></i>E-posta
                                        </th>
                                        <th>
                                            <i class="fas fa-calendar-plus me-1"></i>Kayıt Tarihi
                                        </th>
                                        <th>
                                            <i class="fas fa-fingerprint me-1"></i>User ID
                                        </th>
                                        <th>
                                            <i class="fas fa-toggle-on me-1"></i>Durum
                                        </th>
                                        <th width="200" class="text-center">
                                            <i class="fas fa-cogs me-1"></i>İşlemler
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="subscriptionsTableBody">
                                    @if (Model.Subscriptions != null && Model.Subscriptions.Any())
                                    {
                                        int counter = 1;
                                        foreach (var sub in Model.Subscriptions)
                                        {
                                            var user = sub.User;
                                            var userName = user?.UserName ?? "Bilinmeyen";
                                            var userEmail = user?.Email ?? "Belirtilmemiş";
                                            var initial = userName.ToUpper().FirstOrDefault();
                                            var avatarColor = counter % 2 == 0 ? "bg-gradient-primary" : "bg-gradient-info";
                                            
                                            <tr class="melody-table-row" data-id="@sub.Id" data-userid="@sub.UserId">
                                                <td class="text-center">
                                                    <div class="melody-avatar-wrapper">
                                                        <div class="melody-avatar d-flex align-items-center justify-content-center @avatarColor text-white" style="width: 40px; height: 40px; border: none;">
                                                            <span class="font-weight-bold">@initial</span>
                                                        </div>
                                                        <span class="melody-avatar-badge melody-badge-success">@counter</span>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="ms-3">
                                                            <div class="font-weight-bold text-primary">@userName</div>
                                                            <div class="small text-muted">
                                                                <i class="fas fa-user-circle me-1"></i>@(user?.Email ?? "E-posta yok")
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="melody-contact-info">
                                                        <i class="fas fa-envelope text-muted me-1"></i>
                                                        <span>@userEmail</span>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="melody-date-info">
                                                        <i class="fas fa-calendar text-muted me-1"></i>
                                                        <span>@sub.CreatedAt.ToString("dd.MM.yyyy")</span>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="melody-badge melody-badge-secondary">
                                                        <i class="fas fa-fingerprint me-1"></i>@sub.UserId.Substring(0, Math.Min(10, sub.UserId.Length))...
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="melody-badge @(sub.IsActive ? "melody-badge-success" : "melody-badge-danger")">
                                                        <i class="fas fa-toggle-@(sub.IsActive ? "on" : "off") me-1"></i>@(sub.IsActive ? "Aktif" : "Pasif")
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="melody-action-buttons btn-group" role="group">
                                                        <button class="btn btn-sm btn-outline-success melody-btn melody-btn-sm btn-send-user"
                                                                data-userid="@sub.UserId" data-username="@userName" title="Bildirim Gönder">
                                                            <i class="fas fa-paper-plane"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-info melody-btn melody-btn-sm btn-view-details"
                                                                data-id="@sub.Id" title="Detaylar">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger melody-btn melody-btn-sm btn-delete-sub"
                                                                data-id="@sub.Id" title="Sil">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            counter++;
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="7" class="text-center text-muted py-5 melody-empty-state">
                                                <div class="melody-empty-content">
                                                    <i class="fas fa-bell-slash fa-3x mb-3 text-muted"></i>
                                                    <h5 class="text-muted mb-2">Henüz Abonelik Bulunmuyor</h5>
                                                    <p class="text-muted mb-4">Kullanıcılar bildirimlere abone olduğunda burada görünecektir.</p>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Logs Tab -->
                    <div class="tab-pane fade" id="logs-tab-pane" role="tabpanel">
                        <div class="table-responsive melody-table-responsive">
                            <table class="table melody-table table-hover mb-0" id="logsTable">
                                <thead class="melody-table-header">
                                    <tr>
                                        <th width="60"><i class="fas fa-hashtag"></i></th>
                                        <th><i class="fas fa-user me-1"></i>Kullanıcı</th>
                                        <th><i class="fas fa-envelope me-1"></i>Başlık</th>
                                        <th><i class="fas fa-comment me-1"></i>Mesaj</th>
                                        <th><i class="fas fa-clock me-1"></i>Tarih</th>
                                        <th><i class="fas fa-toggle-on me-1"></i>Durum</th>
                                    </tr>
                                </thead>
                                <tbody id="logsTableBody">
                                    @if (Model.NotificationLogs != null && Model.NotificationLogs.Any())
                                    {
                                        int counter = 1;
                                        foreach (var log in Model.NotificationLogs)
                                        {
                                            <tr class="melody-table-row">
                                                <td class="text-center">
                                                    <span class="melody-badge melody-badge-secondary">@counter</span>
                                                </td>
                                                <td>
                                                    <div class="font-weight-bold text-primary">@log.UserId</div>
                                                </td>
                                                <td>
                                                    <div class="text-truncate" style="max-width: 200px;">@log.Title</div>
                                                </td>
                                                <td>
                                                    <div class="text-truncate" style="max-width: 250px;" title="@log.Body">@log.Body</div>
                                                </td>
                                                <td>
                                                    <div class="melody-date-info">
                                                        <i class="fas fa-clock text-muted me-1"></i>
                                                        <span>@log.SentAt.ToString("dd.MM.yyyy HH:mm")</span>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="melody-badge @(log.Success ? "melody-badge-success" : "melody-badge-danger")">
                                                        <i class="fas fa-@(log.Success ? "check" : "times")-circle me-1"></i>
                                                        @(log.Success ? "Başarılı" : "Başarısız")
                                                    </span>
                                                </td>
                                            </tr>
                                            counter++;
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-5 melody-empty-state">
                                                <div class="melody-empty-content">
                                                    <i class="fas fa-history fa-3x mb-3 text-muted"></i>
                                                    <h5 class="text-muted mb-2">Bildirim Geçmişi Boş</h5>
                                                    <p class="text-muted mb-4">Henüz hiç bildirim gönderilmemiş.</p>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Send Notification Modal -->
<div class="modal fade" id="sendNotificationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content melody-modal-content">
            <div class="modal-header melody-modal-header melody-modal-header-primary">
                <h5 class="modal-title melody-modal-title">
                    <i class="fas fa-paper-plane me-2"></i>Push Bildirim Gönder
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body melody-modal-body">
                <div class="melody-form-group mb-3">
                    <label class="melody-form-label">Alıcı</label>
                    <select class="form-select melody-form-select" id="recipientType">
                        <option value="all">Tüm Aktif Kullanıcılar</option>
                        <option value="student">Öğrenciler</option>
                        <option value="teacher">Öğretmenler</option>
                        <option value="specific">Belirli Kullanıcı</option>
                    </select>
                </div>
                <div class="melody-form-group mb-3" id="specificUserGroup" style="display: none;">
                    <label class="melody-form-label">Kullanıcı</label>
                    <select class="form-select melody-form-select" id="specificUserId">
                        @if (Model.Subscriptions != null)
                        {
                            foreach (var sub in Model.Subscriptions)
                            {
                                <option value="@sub.UserId">@sub.User?.UserName (@sub.User?.Email)</option>
                            }
                        }
                    </select>
                </div>
                <div class="melody-form-group mb-3">
                    <label class="melody-form-label">Başlık <span class="text-danger">*</span></label>
                    <input type="text" class="form-control melody-form-control" id="notifTitle" placeholder="Bildirim başlığı" required>
                </div>
                <div class="melody-form-group mb-3">
                    <label class="melody-form-label">Mesaj <span class="text-danger">*</span></label>
                    <textarea class="form-control melody-form-control" id="notifBody" rows="3" placeholder="Bildirim mesajı" required></textarea>
                </div>
                <div class="melody-form-group mb-3">
                    <label class="melody-form-label">URL (Opsiyonel)</label>
                    <input type="text" class="form-control melody-form-control" id="notifUrl" placeholder="https://site.com/sayfa">
                </div>
            </div>
            <div class="modal-footer melody-modal-footer">
                <button class="btn btn-secondary melody-btn" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>İptal
                </button>
                <button class="btn btn-primary melody-btn" id="sendNotificationBtn">
                    <i class="fas fa-paper-plane me-2"></i>Gönder
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Subscription Modal -->
<div class="modal fade" id="deleteSubscriptionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content melody-modal-content">
            <div class="modal-header melody-modal-header melody-modal-header-danger">
                <h5 class="modal-title melody-modal-title">
                    <i class="fas fa-trash me-2"></i>Abonelik Silme Onayı
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body melody-modal-body">
                <input type="hidden" id="deleteSubId">
                <div class="text-center mb-3">
                    <div class="melody-danger-icon mb-3">
                        <i class="fas fa-trash"></i>
                    </div>
                    <p class="mb-2 fs-5">Bu aboneliği silmek istediğinizden emin misiniz?</p>
                    <p class="text-muted small mb-0">Bu işlem geri alınamaz.</p>
                </div>
            </div>
            <div class="modal-footer melody-modal-footer">
                <button class="btn btn-secondary melody-btn" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>İptal
                </button>
                <button class="btn btn-danger melody-btn" id="confirmDeleteSubBtn">
                    <i class="fas fa-trash me-2"></i>Sil
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            function melodyHas(fn) { return window.MelodyTheme && typeof window.MelodyTheme[fn] === 'function'; }
            function toast(msg, type) {
                if (melodyHas('showToast')) { window.MelodyTheme.showToast(msg, type); }
                else { if (typeof window.showAlert === 'function') window.showAlert(msg, type === 'error' ? 'danger' : (type || 'info')); }
            }

            if (melodyHas('init')) { window.MelodyTheme.init(); }

            // Initialize tooltips
            $('[data-bs-toggle="tooltip"]').tooltip({
                template: '<div class="tooltip melody-tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>'
            });

            // Recipient type change
            $('#recipientType').on('change', function() {
                if ($(this).val() === 'specific') {
                    $('#specificUserGroup').slideDown();
                } else {
                    $('#specificUserGroup').slideUp();
                }
            });

            // Send notification button
            $('#sendNotificationBtn').on('click', function() {
                const title = $('#notifTitle').val().trim();
                const body = $('#notifBody').val().trim();
                const url = $('#notifUrl').val().trim();
                const recipientType = $('#recipientType').val();
                const specificUserId = $('#specificUserId').val();

                if (!title || !body) {
                    toast('Başlık ve mesaj zorunludur.', 'error');
                    return;
                }

                let requestData = {
                    title: title,
                    body: body,
                    url: url || null
                };

                if (recipientType === 'specific') {
                    requestData.userId = specificUserId;
                } else if (recipientType === 'student' || recipientType === 'teacher') {
                    // For role-based, we'll send multiple notifications
                    requestData.userIds = [];
                    $('#specificUserId option').each(function() {
                        const userId = $(this).val();
                        const userName = $(this).text();
                        if (recipientType === 'student' && userName.toLowerCase().includes('student')) {
                            requestData.userIds.push(userId);
                        }
                    });
                }

                toast('Bildirim gönderiliyor...', 'info');

                $.ajax({
                    url: recipientType === 'specific' ? '/Notification/SendNotification' : '/Notification/SendBulkNotification',
                    type: 'POST',
                    data: requestData,
                    success: function(res) {
                        if (res.success) {
                            toast(res.message || 'Bildirim başarıyla gönderildi!', 'success');
                            bootstrap.Modal.getInstance(document.getElementById('sendNotificationModal')).hide();
                            $('#notifTitle').val('');
                            $('#notifBody').val('');
                            $('#notifUrl').val('');
                            setTimeout(function() { location.reload(); }, 1500);
                        } else {
                            toast(res.message || 'Hata oluştu', 'error');
                        }
                    },
                    error: function() {
                        toast('Bağlantı hatası', 'error');
                    }
                });
            });

            // Send notification to specific user from table
            $(document).on('click', '.btn-send-user', function() {
                const userId = $(this).data('userid');
                const userName = $(this).data('username');
                
                $('#sendNotificationModal').modal('show');
                $('#recipientType').val('specific').trigger('change');
                $('#specificUserId').val(userId);
                $('#notifTitle').val('');
                $('#notifBody').val('');
                $('#notifUrl').val('');
            });

            // View subscription details
            $(document).on('click', '.btn-view-details', function() {
                const id = $(this).data('id');
                toast('Abonelik detayları yükleniyor...', 'info');
                // Could implement a details modal here
            });

            // Delete subscription
            $(document).on('click', '.btn-delete-sub', function() {
                const id = $(this).data('id');
                $('#deleteSubId').val(id);
                new bootstrap.Modal(document.getElementById('deleteSubscriptionModal')).show();
            });

            $('#confirmDeleteSubBtn').on('click', function() {
                const id = $('#deleteSubId').val();
                toast('Abonelik siliniyor...', 'info');
                
                $.ajax({
                    url: '/Notification/DeleteSubscription',
                    type: 'POST',
                    data: { id: id },
                    success: function(res) {
                        if (res.success) {
                            toast(res.message || 'Abonelik silindi', 'success');
                            bootstrap.Modal.getInstance(document.getElementById('deleteSubscriptionModal')).hide();
                            setTimeout(function() { location.reload(); }, 1500);
                        } else {
                            toast(res.message || 'Hata oluştu', 'error');
                        }
                    },
                    error: function() {
                        toast('Bağlantı hatası', 'error');
                    }
                });
            });

            // Test subscription button
            $('#testSubscriptionBtn').on('click', function() {
                $.get('/Notification/GetVapidPublicKey', function(res) {
                    if (res.success) {
                        toast('VAPID Public Key: ' + res.publicKey.substring(0, 20) + '...', 'info');
                    } else {
                        toast(res.message || 'VAPID anahtarı alınamadı', 'error');
                    }
                });
            });

            // Enhanced table row animations
            $('.melody-table-row').on('mouseenter', function() {
                $(this).addClass('row-hovered');
            }).on('mouseleave', function() {
                $(this).removeClass('row-hovered');
            });
        });
    </script>
}
