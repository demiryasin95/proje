@{
    ViewBag.Title = "Bildirim Testi";
}

@Html.AntiForgeryToken()

<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-bell-fill me-2"></i>Push Notification Test SayfasÄ±
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Status -->
                    <div class="alert alert-info">
                        <h5><i class="bi bi-info-circle me-2"></i>Bildirim Durumu</h5>
                        <p class="mb-2">
                            <strong>TarayÄ±cÄ± DesteÄŸi:</strong> 
                            <span id="browserSupport" class="badge bg-secondary">Kontrol ediliyor...</span>
                        </p>
                        <p class="mb-2">
                            <strong>Ä°zin Durumu:</strong> 
                            <span id="permissionStatus" class="badge bg-secondary">Kontrol ediliyor...</span>
                        </p>
                        <p class="mb-0">
                            <strong>Abonelik Durumu:</strong> 
                            <span id="subscriptionStatus" class="badge bg-secondary">Kontrol ediliyor...</span>
                        </p>
                    </div>

                    <!-- Actions -->
                    <div class="mb-4">
                        <h5><i class="bi bi-gear me-2"></i>Ä°ÅŸlemler</h5>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="requestPermission()">
                                <i class="bi bi-check-circle me-2"></i>Bildirim Ä°zni Ä°ste
                            </button>
                            <button class="btn btn-success" onclick="subscribeToPush()">
                                <i class="bi bi-bell me-2"></i>Bildirimlere Abone Ol
                            </button>
                            <button class="btn btn-info" onclick="sendTestNotification()">
                                <i class="bi bi-send me-2"></i>Test Bildirimi GÃ¶nder
                            </button>
                            <button class="btn btn-warning" onclick="checkSubscription()">
                                <i class="bi bi-search me-2"></i>Abonelik Durumunu Kontrol Et
                            </button>
                            <button class="btn btn-danger" onclick="unsubscribeFromPush()">
                                <i class="bi bi-x-circle me-2"></i>Abonelikten Ã‡Ä±k
                            </button>
                        </div>
                    </div>

                    <!-- Console Log -->
                    <div>
                        <h5><i class="bi bi-terminal me-2"></i>Log</h5>
                        <div id="consoleLog" class="bg-dark text-light p-3 rounded" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;">
                            <div class="text-success">Push Notification Test Console</div>
                            <div class="text-muted">Sistem hazÄ±r...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        // Logging function
        function log(message, type = 'info') {
            const consoleLog = document.getElementById('consoleLog');
            const timestamp = new Date().toLocaleTimeString('tr-TR');
            const colors = {
                'info': 'text-info',
                'success': 'text-success',
                'error': 'text-danger',
                'warning': 'text-warning'
            };
            const colorClass = colors[type] || 'text-light';
            consoleLog.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            consoleLog.scrollTop = consoleLog.scrollHeight;
            console.log(`[Push Test] ${message}`);
        }

        // Check initial status
        function checkStatus() {
            // Browser support
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                document.getElementById('browserSupport').textContent = 'Destekleniyor';
                document.getElementById('browserSupport').className = 'badge bg-success';
                log('âœ“ TarayÄ±cÄ± push notification destekliyor', 'success');
            } else {
                document.getElementById('browserSupport').textContent = 'Desteklenmiyor';
                document.getElementById('browserSupport').className = 'badge bg-danger';
                log('âœ— TarayÄ±cÄ± push notification desteklemiyor!', 'error');
                return;
            }

            // Permission status
            const permission = Notification.permission;
            const permissionBadge = document.getElementById('permissionStatus');
            if (permission === 'granted') {
                permissionBadge.textContent = 'Ä°zin Verildi';
                permissionBadge.className = 'badge bg-success';
                log('âœ“ Bildirim izni verilmiÅŸ', 'success');
            } else if (permission === 'denied') {
                permissionBadge.textContent = 'Ä°zin Reddedildi';
                permissionBadge.className = 'badge bg-danger';
                log('âœ— Bildirim izni reddedilmiÅŸ', 'error');
            } else {
                permissionBadge.textContent = 'Ä°zin Ä°stenmedi';
                permissionBadge.className = 'badge bg-warning';
                log('âš  Bildirim izni henÃ¼z istenmedi', 'warning');
            }

            // Check subscription
            checkSubscription();
        }

        // Request permission
        async function requestPermission() {
            try {
                log('Bildirim izni isteniyor...', 'info');
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    log('âœ“ Bildirim izni verildi!', 'success');
                    checkStatus();
                } else {
                    log('âœ— Bildirim izni reddedildi', 'error');
                    checkStatus();
                }
            } catch (error) {
                log('Hata: ' + error.message, 'error');
            }
        }

        // Subscribe to push
        async function subscribeToPush() {
            try {
                log('Push notification aboneliÄŸi baÅŸlatÄ±lÄ±yor...', 'info');

                // Get VAPID key
                log('VAPID public key alÄ±nÄ±yor...', 'info');
                const keyResponse = await fetch('/Notification/GetVapidPublicKey');
                const keyData = await keyResponse.json();

                if (!keyData.success || !keyData.publicKey) {
                    throw new Error('VAPID key alÄ±namadÄ±');
                }
                log('âœ“ VAPID key alÄ±ndÄ±: ' + keyData.publicKey.substring(0, 20) + '...', 'success');

                // Register service worker
                log('Service Worker kaydediliyor...', 'info');
                const registration = await navigator.serviceWorker.register('/service-worker.js', { scope: '/' });
                log('âœ“ Service Worker kaydedildi', 'success');

                await navigator.serviceWorker.ready;
                log('âœ“ Service Worker hazÄ±r', 'success');

                // Subscribe
                log('Push Manager subscribe ediliyor...', 'info');
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(keyData.publicKey)
                });
                log('âœ“ Push subscription oluÅŸturuldu', 'success');

                // Send to server
                const endpoint = subscription.endpoint;
                const keys = subscription.toJSON().keys;

                log('Subscription sunucuya gÃ¶nderiliyor...', 'info');
                const response = await fetch('/Notification/Subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': getToken(),
                        'X-CSRF-TOKEN': getToken()
                    },
                    body: new URLSearchParams({
                        endpoint: endpoint,
                        p256dh: keys.p256dh,
                        auth: keys.auth
                    })
                });

                const data = await response.json();
                if (data.success) {
                    log('âœ“ Subscription baÅŸarÄ±yla kaydedildi!', 'success');
                    checkStatus();
                } else {
                    throw new Error(data.message);
                }

            } catch (error) {
                log('âœ— Hata: ' + error.message, 'error');
            }
        }

        // Check subscription
        async function checkSubscription() {
            try {
                const registration = await navigator.serviceWorker.getRegistration('/');
                if (!registration) {
                    document.getElementById('subscriptionStatus').textContent = 'Service Worker Yok';
                    document.getElementById('subscriptionStatus').className = 'badge bg-warning';
                    log('Service Worker kayÄ±tlÄ± deÄŸil', 'warning');
                    return;
                }

                const subscription = await registration.pushManager.getSubscription();
                const statusBadge = document.getElementById('subscriptionStatus');
                
                if (subscription) {
                    statusBadge.textContent = 'Abone';
                    statusBadge.className = 'badge bg-success';
                    log('âœ“ KullanÄ±cÄ± bildirimlere abone', 'success');
                    log('Endpoint: ' + subscription.endpoint.substring(0, 50) + '...', 'info');
                } else {
                    statusBadge.textContent = 'Abone DeÄŸil';
                    statusBadge.className = 'badge bg-warning';
                    log('âš  KullanÄ±cÄ± bildirimlere abone deÄŸil', 'warning');
                }
            } catch (error) {
                log('âœ— Kontrol hatasÄ±: ' + error.message, 'error');
            }
        }

        // Send test notification
        async function sendTestNotification() {
            try {
                log('Test bildirimi gÃ¶nderiliyor...', 'info');
                
                const registration = await navigator.serviceWorker.ready;
                
                // Use unique tag each time so notifications don't replace each other
                const uniqueTag = 'test-' + Date.now();
                
                await registration.showNotification('Test Bildirimi ðŸ””', {
                    body: 'Push notification sistemi baÅŸarÄ±yla Ã§alÄ±ÅŸÄ±yor! (' + new Date().toLocaleTimeString('tr-TR') + ')',
                    icon: '/Content/Images/logo.png',
                    badge: '/Content/Images/badge.png',
                    tag: uniqueTag,
                    requireInteraction: false
                });

                log('âœ“ Test bildirimi gÃ¶nderildi! (Tag: ' + uniqueTag + ')', 'success');
            } catch (error) {
                log('âœ— Bildirim gÃ¶nderilemedi: ' + error.message, 'error');
            }
        }

        // Unsubscribe
        async function unsubscribeFromPush() {
            try {
                log('Abonelikten Ã§Ä±kÄ±lÄ±yor...', 'info');

                const registration = await navigator.serviceWorker.getRegistration('/');
                if (!registration) {
                    log('Service Worker bulunamadÄ±', 'warning');
                    return;
                }

                const subscription = await registration.pushManager.getSubscription();
                if (!subscription) {
                    log('Zaten abone deÄŸilsiniz', 'warning');
                    return;
                }

                const endpoint = subscription.endpoint;
                await subscription.unsubscribe();
                log('âœ“ TarayÄ±cÄ± aboneliÄŸi iptal edildi', 'success');

                // Notify server
                const response = await fetch('/Notification/Unsubscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': getToken(),
                        'X-CSRF-TOKEN': getToken()
                    },
                    body: new URLSearchParams({ endpoint: endpoint })
                });

                const data = await response.json();
                if (data.success) {
                    log('âœ“ Sunucu aboneliÄŸi iptal edildi', 'success');
                    checkStatus();
                } else {
                    log('âš  Sunucu hatasÄ±: ' + data.message, 'warning');
                }

            } catch (error) {
                log('âœ— Hata: ' + error.message, 'error');
            }
        }

        // Helper functions
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        function getToken() {
            const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            return tokenInput ? tokenInput.value : '';
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            log('Sayfa yÃ¼klendi, durum kontrol ediliyor...', 'info');
            checkStatus();
        });
    </script>
}
