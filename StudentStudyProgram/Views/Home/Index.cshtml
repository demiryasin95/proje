@model StudentStudyProgram.Models.WeeklyCalendarViewModel
@{
    ViewBag.Title = "Ana Sayfa";
    var isStudent = User.IsInRole("Student");
    var isTeacher = User.IsInRole("Teacher") && !User.IsInRole("Admin");
    var myTeacherId = (ViewBag.MyTeacherId != null) ? (int)ViewBag.MyTeacherId : 0;
    var myTeacherName = (ViewBag.MyTeacherName as string) ?? "";
}



    <div class="melody-toolbar">
        <div class="d-flex align-items-center gap-3">
            <div class="melody-brand-badge" style="width: 48px; height: 48px; border-radius: 14px;">
                <i class="bi bi-calendar-check-fill" style="font-size: 1.5rem;"></i>
            </div>
            <h2 class="melody-toolbar-title">Haftalık Etüt Programı</h2>
        </div>
        
        <div class="d-flex align-items-center gap-3 flex-wrap">
            @if (!isStudent && !isTeacher)
            {
                <div class="teacher-select-wrapper">
                    <select id="teacherSelect" class="form-select">
                        <option value="">Öğretmen Seçin</option>
                    @foreach (var teacher in (IEnumerable<System.Web.Mvc.SelectListItem>)ViewBag.Teachers)
                    {
                        <option value="@teacher.Value">@teacher.Text</option>
                    }
                    </select>
                </div>
            }
            
            <div class="d-flex gap-2 week-nav-buttons p-1 rounded-3 border shadow-sm">
                <button id="prevWeek" class="melody-btn-icon" title="Önceki Hafta">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <button id="today" class="melody-btn-primary" title="Bugün">
                    <i class="bi bi-calendar-event"></i>
                    <span>Bugün</span>
                </button>
                <button id="nextWeek" class="melody-btn-icon" title="Sonraki Hafta">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow border-0" style="background: transparent; box-shadow: none !important;">
                <div class="card-header melody-card-header rounded-top-4 border-0 mb-3 text-center d-flex justify-content-between align-items-center p-4">
                     <div class="d-flex align-items-center gap-2">
                        <div class="badge melody-badge-translucent backdrop-blur border border-opacity-25" style="font-size: 1.1rem; padding: 0.8rem 1.2rem;">
                            <i class="bi bi-clock-history me-2"></i>
                            <span id="currentWeek">@Model.WeekStart.ToString("dd MMMM yyyy") - @Model.WeekStart.AddDays(6).ToString("dd MMMM yyyy")</span>
                        </div>
                     </div>
                     
                     <div class="badge melody-badge-primary shadow-lg" style="font-size: 1rem; padding: 0.8rem 1.5rem; border-radius: 50px;">
                        <i class="bi bi-person-badge me-2"></i>
                        <span id="selectedTeacherName">Tüm Öğretmenler</span>
                     </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive rounded-4 shadow-lg melody-table-container">
                        <table class="table table-bordered mb-0" id="calendarTable" style="table-layout: fixed; min-width: 1000px;">
                            <colgroup>
                                <col style="width: 100px;">
                                @for (int i = 0; i < 7; i++)
                                {
                                    <col style="width: calc((100% - 100px) / 7);">
                                }
                            </colgroup>
                            <thead class="melody-table-header">
                                <tr id="calendarHeaderRow">
                                    <th class="text-center fw-semibold">Saat</th>
                                    @for (int i = 0; i < 7; i++)
                                    {
                                        var currentDate = Model.WeekStart.AddDays(i);
                                        <th class="text-center fw-semibold" data-day="@i">
                                            <div class="day-name">@currentDate.ToString("ddd")</div>
                                            <div class="small text-muted day-date">@currentDate.ToString("dd/MM")</div>
                                        </th>
                                    }
                                </tr>
                            </thead>
                            <tbody id="calendarBody">
                                @foreach (var timeSlot in Model.TimeSlots)
                                {
                                    <tr>
                                        <td class="text-center bg-light fw-semibold" style="padding: 0.75rem;">
                                            <div>@timeSlot.StartTime.ToString(@"hh\:mm")</div>
                                            <div class="small text-muted">@timeSlot.EndTime.ToString(@"hh\:mm")</div>
                                        </td>
                                        @for (int i = 0; i < 7; i++)
                                        {
                                            var currentDate = Model.WeekStart.AddDays(i);
                                            <td class="calendar-cell"
                                                data-date="@currentDate.ToString("yyyy-MM-dd")"
                                                data-time-slot="@timeSlot.Id"
                                                data-day="@((int)currentDate.DayOfWeek == 0 ? 7 : (int)currentDate.DayOfWeek)"
                                                style="min-width: 120px; padding: 0.5rem;">
                                                <div class="cell-content min-height-cell">
                                                    @if (timeSlot.Type == "Lesson" && !isStudent)
                                                    {
                                                        <button class="btn btn-sm btn-outline-primary add-session-btn w-100"
                                                                onclick="openAddSessionModal('@currentDate.ToString("yyyy-MM-dd")', '@timeSlot.Id')">
                                                            <i class="bi bi-plus-circle me-1"></i>Etüt Ekle
                                                        </button>
                                                    }
                                                    else
                                                    {
                                                        var typeDisplay = timeSlot.Type == "Break" ? "Ara" :
                                                                         timeSlot.Type == "Lunch" ? "Öğle Arası" :
                                                                         timeSlot.Type == "Lesson" ? "Ders" : timeSlot.Type;
                                                        <div class="text-center text-muted small">
                                                            @(isStudent && timeSlot.Type == "Lesson" ? "-" : typeDisplay)
                                                        </div>
                                                    }
                                                </div>
                                            </td>
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Study Session Modal -->
<div class="modal fade" id="addSessionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle me-2"></i>Yeni Etüt Kaydı
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addSessionForm">
                    @Html.AntiForgeryToken()
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Tarih</label>
                            <input type="date" id="sessionDate" class="form-control" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Saat Aralığı</label>
                            <input type="text" id="timeSlotDisplay" class="form-control" readonly>
                            <input type="hidden" id="timeSlotId">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Öğretmen</label>
                            <input type="text" id="teacherDisplay" class="form-control" readonly>
                            <input type="hidden" id="teacherId">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Etüt Türü</label>
                            <div class="d-flex gap-3 align-items-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="sessionType" id="typeIndividual" value="Individual" checked>
                                    <label class="form-check-label" for="typeIndividual">Birebir</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="sessionType" id="typeGroup" value="Group">
                                    <label class="form-check-label" for="typeGroup">Grup</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Öğrenci Ara</label>
                        <div class="input-group">
                            <input type="text" id="studentSearch" class="form-control" placeholder="Öğrenci adı, soyadı veya sınıfı ile arayın...">
                            <button type="button" class="btn btn-outline-secondary" onclick="searchStudents()">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Öğrenciler</label>
                        <div id="studentResults" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                            <p class="text-muted text-center">Arama yaparak öğrenci bulun...</p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Seçilen Öğrenciler</label>
                        <div id="selectedStudents" class="d-flex flex-wrap gap-2"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>İptal
                </button>
                <button type="button" class="btn btn-primary" onclick="saveStudySession()">
                    <i class="bi bi-save me-1"></i>Kaydet
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Silme Onayı</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">Bu etüt kaydını silmek istiyor musunuz?</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Sil</button>
            </div>
        </div>
    </div>
</div>

<!-- Modern Confirmation Modal for Drag & Drop -->
<div class="modal fade" id="moveConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content melody-card border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title d-flex align-items-center">
                    <i class="fas fa-arrows-alt text-primary me-2"></i>
                    Etüt Taşıma Onayı
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body py-4">
                <p class="mb-0 text-gray-700">Bu etütü taşımak istediğinizden emin misiniz?</p>
                <small class="text-muted d-block mt-2">
                    <i class="fas fa-info-circle me-1"></i>
                    Etüt yeni tarihe ve saate taşınacaktır.
                </small>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>İptal
                </button>
                <button type="button" class="btn btn-primary" id="confirmMoveBtn">
                    <i class="fas fa-check me-1"></i>Tamam
                </button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        const isStudent = @isStudent.ToString().ToLowerInvariant();
        const isTeacher = @isTeacher.ToString().ToLowerInvariant();
        const myTeacherId = @myTeacherId;
        const myTeacherName = '@(myTeacherName.Replace("'", "\\'"))';
        let currentWeekStart;
        let selectedTeacherId = '';
        let weekTimeSlots = [];
        let selectedStudents = [];
        let pendingDeleteSessionId = null;
        let selectedSessionType = 'Individual';
        let teacherAvailabilities = new Set(); // Store teacher availabilities as "dayOfWeek-timeSlotId"

        function translateTimeSlotType(type) {
            const translations = {
                'Break': 'Ara',
                'Lunch': 'Öğle Arası',
                'Lesson': 'Ders'
            };
            return translations[type] || type;
        }

        $(document).ready(function() {
            const today = new Date();
            currentWeekStart = getWeekStart(today);
            
            if (!isStudent && !isTeacher) {
                $('#teacherSelect').change(function() {
                    selectedTeacherId = $(this).val();
                    updateSelectedTeacherName();
                    loadWeeklyCalendar();
                });
            }

            $('#prevWeek').click(function() {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                loadWeeklyCalendar();
            });

            $('#nextWeek').click(function() {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                loadWeeklyCalendar();
            });

            $('#today').click(function() {
                const today = new Date();
                currentWeekStart = getWeekStart(today);
                loadWeeklyCalendar();
            });

            $('#studentSearch').on('input', function() {
                searchStudents();
            });

            $('input[name="sessionType"]').on('change', function() {
                selectedSessionType = $('input[name="sessionType"]:checked').val() || 'Individual';
                if (selectedSessionType === 'Individual' && selectedStudents.length > 1) {
                    selectedStudents = [ selectedStudents[0] ];
                    renderSelectedStudents();
                }
            });

            $('#confirmDeleteBtn').on('click', function(){
                if (pendingDeleteSessionId) {
                    deleteStudySession(pendingDeleteSessionId);
                    pendingDeleteSessionId = null;
                }
            });

            if (isTeacher && myTeacherId > 0) {
                selectedTeacherId = String(myTeacherId);
            }
            updateSelectedTeacherName();
            
            loadWeeklyCalendar();
        });

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = day === 0 ? 6 : day - 1;
            d.setDate(d.getDate() - diff);
            return d;
        }

        // Helper function to format date as YYYY-MM-DD without UTC conversion
        function formatLocalDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function updateSelectedTeacherName() {
            if (isStudent) {
                $('#selectedTeacherName').text('Benim Etütlerim');
                return;
            }
            if (isTeacher) {
                $('#selectedTeacherName').text(myTeacherName || 'Benim Takvimim');
                return;
            }
            const teacherName = selectedTeacherId ? 
                $('#teacherSelect option:selected').text() : 'Tüm Öğretmenler';
            $('#selectedTeacherName').text(teacherName);
        }

        function loadWeeklyCalendar() {
            const weekStartStr = formatLocalDate(currentWeekStart);
            
            $.get('/StudySession/GetWeeklyCalendar', {
                teacherId: isStudent ? '' : selectedTeacherId,
                weekStart: weekStartStr
            }, function(data) {
                
                weekTimeSlots = Array.isArray(data.timeSlots) ? data.timeSlots : [];
                
                // Store teacher availabilities
                teacherAvailabilities.clear();
                if (data.teacherAvailabilities && Array.isArray(data.teacherAvailabilities)) {
                    data.teacherAvailabilities.forEach(function(av) {
                        const key = `${av.dayOfWeek}-${av.timeSlotId}`;
                        teacherAvailabilities.add(key);
                    });
                }
                console.log('Availabilities:', Array.from(teacherAvailabilities));
                
                updateWeekDisplay();
                updateCalendarDisplay(data);
            });
        }

        function updateCalendarDisplay(data) {
            
            // Clear all cells first
            $('.calendar-cell .cell-content').empty();
            
            // Re-add default content based on cell type and teacher availability
            let unavailableCount = 0;
            $('.calendar-cell').each(function() {
                const cell = $(this);
                const timeSlotId = parseInt(cell.attr('data-time-slot'), 10);
                const dayOfWeek = parseInt(cell.attr('data-day'), 10);
                const timeSlot = (data.timeSlots || []).find(t => t.id === timeSlotId);
                
                // Check if teacher is available for this day and time
                const availabilityKey = `${dayOfWeek}-${timeSlotId}`;
                const isTeacherAvailable = teacherAvailabilities.size === 0 || teacherAvailabilities.has(availabilityKey);
                
                if (!isStudent && timeSlot && timeSlot.type === 'Lesson') {
                    const cellDate = cell.attr('data-date');
                    
                    // If a teacher is selected and they are NOT available, show "Müsait Değil"
                    if (selectedTeacherId && !isTeacherAvailable) {
                        unavailableCount++;
                        cell.find('.cell-content').html(`
                            <div class="text-center p-2 fw-semibold" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.2) 100%); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #991B1B;">
                                <i class="bi bi-x-circle-fill me-1" style="font-size: 1.1rem;"></i>
                                <span style="font-size: 0.85rem;">Müsait Değil</span>
                            </div>
                        `);
                        cell.css('background-color', 'rgba(254, 226, 226, 0.4)');
                    } else {
                        cell.find('.cell-content').html(`
                            <button class="btn btn-sm btn-outline-primary add-session-btn w-100"
                                    onclick="openAddSessionModal('${cellDate}', '${timeSlotId}')">
                                <i class="bi bi-plus-circle me-1"></i>Etüt Ekle
                            </button>
                        `);
                        cell.css('background-color', '');
                    }
                } else if (isStudent && timeSlot && timeSlot.type === 'Lesson') {
                    cell.find('.cell-content').html('<div class="text-center text-muted small">-</div>');
                    cell.css('background-color', '');
                } else if (timeSlot) {
                    cell.find('.cell-content').html(`<div class="text-center text-muted small">${translateTimeSlotType(timeSlot.type)}</div>`);
                    cell.css('background-color', '');
                }
            });
            
            // Now add sessions
            (data.studySessions || []).forEach(function(session) {
                const sessionDate = session.date ? session.date.split('T')[0] : '';
                const sessionTimeSlotId = parseInt(session.timeSlotId, 10);
                
                const selector = `.calendar-cell[data-date="${sessionDate}"][data-time-slot="${sessionTimeSlotId}"]`;
                const matchingCell = $(selector);
                
                if (matchingCell.length > 0) {
                    const statusClass = session.attendanceStatus === 'Attended' ? 'attended' : 
                                        session.attendanceStatus === 'NotAttended' ? 'notattended' : 'pending';
                    const actionButtons = isStudent ? '' : `
                        <button class="btn btn-sm btn-outline-success" onclick="updateAttendance(${session.id}, 'Attended')" 
                                title="Geldi" ${session.attendanceStatus === 'Attended' ? 'disabled' : ''}>
                            <i class="bi bi-check-lg"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="updateAttendance(${session.id}, 'NotAttended')" 
                                title="Gelmedi" ${session.attendanceStatus === 'NotAttended' ? 'disabled' : ''}>
                            <i class="bi bi-x-lg"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="openDeleteConfirm(${session.id})" title="Sil">
                            <i class="bi bi-trash"></i>
                        </button>`;
                    
                    const sessionHtml = `
                        <div class="study-session ${statusClass} mb-2" data-session-id="${session.id}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-semibold small">${session.studentName}${session.teacherBranch && isStudent ? ' <span class="badge bg-info bg-opacity-75 ms-1" style="font-size: 0.7rem; font-weight: 500;">' + session.teacherBranch + '</span>' : ''}</div>
                                    <div class="small">${session.classroom}</div>
                                </div>
                                <div class="d-flex gap-2 ms-3">${actionButtons}</div>
                            </div>
                        </div>`;
                    
                    matchingCell.find('.cell-content').html(sessionHtml);
                } else {
                    console.error('❌ No cell found for date:', sessionDate, 'timeSlot:', sessionTimeSlotId);
                }
            });
        }

        function updateWeekDisplay() {
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            $('#currentWeek').text(
                `${currentWeekStart.toLocaleDateString('tr-TR')} - ${weekEnd.toLocaleDateString('tr-TR')}`
            );
            
            const dayNames = ['Pzt', 'Sal', 'Çar', 'Per', 'Cum', 'Cmt', 'Paz'];
            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(currentWeekStart);
                currentDate.setDate(currentDate.getDate() + i);
                
                const dayName = dayNames[i];
                const dayDate = currentDate.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' });
                
                $(`th[data-day="${i}"]`).find('.day-name').text(dayName);
                $(`th[data-day="${i}"]`).find('.day-date').text(dayDate);
            }
            
            // Update cell dates using row-based iteration
            $('#calendarTable tbody tr').each(function() {
                $(this).find('td.calendar-cell').each(function(cellIndex) {
                    const cellDate = new Date(currentWeekStart);
                    cellDate.setDate(cellDate.getDate() + cellIndex);
                    const dateStr = formatLocalDate(cellDate);
                    $(this).attr('data-date', dateStr);
                });
            });
        }

        function openAddSessionModal(date, timeSlotId) {
            if (isStudent) {
                alert('Öğrenciler etüt ekleyemez.');
                return;
            }
            if (isTeacher && (!myTeacherId || myTeacherId <= 0)) {
                alert('Bu öğretmen hesabı bir öğretmen kaydına bağlı değil.');
                return;
            }
            if (isTeacher && (!selectedTeacherId || selectedTeacherId === '')) {
                selectedTeacherId = String(myTeacherId || '');
            }
            if (!selectedTeacherId) {
                alert('Lütfen önce bir öğretmen seçin.');
                return;
            }

            $('#sessionDate').val(date);
            $('#timeSlotId').val(timeSlotId);
            $('#teacherId').val(isTeacher ? String(myTeacherId) : selectedTeacherId);

            selectedStudents = [];
            renderSelectedStudents();
            $('#studentSearch').val('');
            $('#studentResults').html('<p class="text-muted text-center">Arama yaparak öğrenci bulun...</p>');
            selectedSessionType = $('input[name="sessionType"]:checked').val() || 'Individual';
            
            const tsId = parseInt(timeSlotId, 10);
            const ts = weekTimeSlots.find(t => t.id === tsId);
            if (ts) {
                $('#timeSlotDisplay').val(`${ts.startTime} - ${ts.endTime}`);
            }
            
            if (isTeacher) {
                $('#teacherDisplay').val(myTeacherName || 'Benim Takvimim');
            } else {
                $('#teacherDisplay').val($('#teacherSelect option:selected').text());
            }
            
            $('#addSessionModal').modal('show');
        }

        function searchStudents() {
            if (isStudent) return;
            const searchTerm = $('#studentSearch').val().trim();
            if (searchTerm.length < 2) {
                $('#studentResults').html('<p class="text-muted text-center">Aramak için en az 2 karakter girin.</p>');
                return;
            }

            $.ajax({ url: '/StudySession/GetStudents', type: 'GET', dataType: 'json', data: { searchTerm } })
            .done(function(data) {
                let list = Array.isArray(data) ? data : (data && Array.isArray(data.students) ? data.students : []);
                if (!list || list.length === 0) {
                    $.get('/Admin/GetStudents', function(fallback) {
                        const alt = (fallback && fallback.students) ? fallback.students : (Array.isArray(fallback) ? fallback : []);
                        displayStudentResults(alt);
                    });
                } else {
                    displayStudentResults(list);
                }
            });
        }

        function displayStudentResults(students) {
            if (students.length === 0) {
                $('#studentResults').html('<p class="text-muted text-center">Öğrenci bulunamadı.</p>');
                return;
            }

            let html = '';
            students.forEach(function(student) {
                html += `
                    <div class="student-item border rounded p-2 mb-2 cursor-pointer" 
                         onclick="selectStudent(${student.id}, '${student.fullName}', '${student.className || ''}')">
                        <div>
                            <div class="fw-semibold">${student.fullName} <span class="small text-muted">(${student.className || ''})</span></div>
                        </div>
                    </div>
                `;
            });
            
            $('#studentResults').html(html);
        }

        function selectStudent(studentId, studentName, className) {
            if (selectedSessionType === 'Individual') {
                selectedStudents = [{ id: studentId, name: studentName, className: className }];
                renderSelectedStudents();
                return;
            }
            if (!selectedStudents.find(s => s.id === studentId)) {
                selectedStudents.push({ id: studentId, name: studentName, className: className });
                renderSelectedStudents();
            }
        }

        function removeSelectedStudent(id) {
            selectedStudents = selectedStudents.filter(s => s.id !== id);
            renderSelectedStudents();
        }

        function renderSelectedStudents() {
            const container = $('#selectedStudents');
            if (selectedStudents.length === 0) {
                container.html('<span class="text-muted">Henüz öğrenci seçilmedi.</span>');
                return;
            }
            let html = '';
            selectedStudents.forEach(function(s){
                html += `<span class="badge bg-primary">
                            ${s.name} <span class="small">(${s.className||''})</span>
                            <button type="button" class="btn btn-sm btn-light ms-2" onclick="removeSelectedStudent(${s.id})">×</button>
                         </span>`;
            });
            container.html(html);
        }

        function saveStudySession() {
            if (isStudent) {
                showModernAlert('Yetki Hatası', 'Öğrenciler etüt ekleyemez.', 'warning');
                return;
            }
            const formData = {
                TeacherId: $('#teacherId').val(),
                StudentIds: selectedStudents.map(s => s.id),
                TimeSlotId: $('#timeSlotId').val(),
                Date: $('#sessionDate').val(),
                SessionType: selectedSessionType
            };

            if (!formData.TeacherId || !formData.StudentIds || formData.StudentIds.length === 0) {
                showModernAlert('Eksik Bilgi', 'Lütfen öğretmen ve en az bir öğrenci seçin.', 'warning');
                return;
            }
            if (formData.SessionType === 'Individual' && formData.StudentIds.length !== 1) {
                showModernAlert('Etüt Türü Hatası', 'Birebir etüt için sadece 1 öğrenci seçilmelidir.', 'warning');
                return;
            }

            $.ajax({
                url: '/StudySession/AddStudySessions',
                type: 'POST',
                headers: {
                    'X-CSRF-TOKEN': $('input[name="__RequestVerificationToken"]').val(),
                    '__RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                data: JSON.stringify(formData),
                contentType: 'application/json',
                success: function(response) {
                    if (response.success) {
                        $('#addSessionModal').modal('hide');
                        showModernAlert('Başarılı', response.message || 'Etütler başarıyla eklendi.', 'success');
                        setTimeout(function() {
                            loadWeeklyCalendar();
                        }, 300);
                    } else {
                        const teacherName = $('#teacherDisplay').val();
                        const studentNames = selectedStudents.map(s => s.name).join(', ');
                        const dateStr = new Date(formData.Date).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
                        const timeStr = $('#timeSlotDisplay').val();
                        
                        showModernAlert(
                            'Müsaitlik Uyarısı',
                            `<strong>${teacherName}</strong> öğretmen <strong>${dateStr}</strong> tarihinde <strong>${timeStr}</strong> saatlerinde müsait değil!<br><br><small class="text-muted">Öğrenci: ${studentNames}</small>`,
                            'error'
                        );
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Etüt ekleme hatası:', error);
                    showModernAlert('Hata', 'Etüt eklenirken bir hata oluştu: ' + (xhr.responseJSON && xhr.responseJSON.message || error), 'error');
                }
            });
        }

        function updateAttendance(sessionId, status) {
            $.ajax({
                url: '/StudySession/UpdateAttendance',
                type: 'POST',
                headers: {
                    'X-CSRF-TOKEN': $('input[name="__RequestVerificationToken"]').val()
                },
                data: {
                    StudySessionId: sessionId,
                    AttendanceStatus: status
                },
                success: function(response) {
                    if (response.success) {
                        if (status === 'Attended') {
                            showNotification('success', 'Öğrenci etüte katılmıştır.');
                        } else if (status === 'NotAttended') {
                            showNotification('danger', 'Öğrenci etüte katılmamıştır.');
                        }
                        loadWeeklyCalendar();
                    } else {
                        alert(response.message || 'Bir hata oluştu.');
                    }
                }
            });
        }

        function deleteStudySession(sessionId) {
            $.ajax({
                url: '/StudySession/DeleteStudySession',
                type: 'POST',
                headers: {
                    'X-CSRF-TOKEN': $('input[name="__RequestVerificationToken"]').val()
                },
                data: { StudySessionId: sessionId },
                success: function(response) {
                    if (response.success) {
                        $('#deleteConfirmModal').modal('hide');
                        loadWeeklyCalendar();
                    } else {
                        alert(response.message || 'Bir hata oluştu.');
                    }
                }
            });
        }

        function openDeleteConfirm(id){
            pendingDeleteSessionId = id;
            $('#deleteConfirmModal').modal('show');
        }

        function showNotification(type, message){
            var container = document.getElementById('toastContainer');
            if (!container) return;
            var id = 't' + Date.now();
            var bg = type === 'success' ? 'bg-success text-white' : 'bg-danger text-white';
            var headerTitle = type === 'success' ? 'Başarılı' : 'Bilgi';
            var el = document.createElement('div');
            el.id = id;
            el.className = 'toast ' + bg;
            el.setAttribute('role','alert');
            el.setAttribute('aria-live','assertive');
            el.setAttribute('aria-atomic','true');
            el.setAttribute('data-bs-delay','2500');
            el.innerHTML = '<div class="toast-header '+bg+'"><strong class="me-auto">'+headerTitle+'</strong><button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button></div>'+
                           '<div class="toast-body">'+message+'</div>';
            container.appendChild(el);
            var toast = new bootstrap.Toast(el);
            toast.show();
            setTimeout(function(){ el.remove(); }, 3000);
        }

        function showModernAlert(title, message, type) {
            // Remove any existing alert
            $('#modernAlertModal').remove();
            
            // Determine icon and colors based on type
            let icon, bgColor, textColor, btnColor;
            switch(type) {
                case 'success':
                    icon = '<i class="bi bi-check-circle-fill" style="font-size: 3rem;"></i>';
                    bgColor = '#10B981';
                    textColor = '#065F46';
                    btnColor = 'btn-success';
                    break;
                case 'error':
                    icon = '<i class="bi bi-x-circle-fill" style="font-size: 3rem;"></i>';
                    bgColor = '#EF4444';
                    textColor = '#991B1B';
                    btnColor = 'btn-danger';
                    break;
                case 'warning':
                    icon = '<i class="bi bi-exclamation-triangle-fill" style="font-size: 3rem;"></i>';
                    bgColor = '#F59E0B';
                    textColor = '#92400E';
                    btnColor = 'btn-warning';
                    break;
                default:
                    icon = '<i class="bi bi-info-circle-fill" style="font-size: 3rem;"></i>';
                    bgColor = '#3B82F6';
                    textColor = '#1E40AF';
                    btnColor = 'btn-primary';
            }
            
            const modalHtml = `
                <div class="modal fade" id="modernAlertModal" tabindex="-1" data-bs-backdrop="static">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
                            <div class="modal-body text-center p-5">
                                <div class="mb-4" style="color: ${bgColor};">
                                    ${icon}
                                </div>
                                <h4 class="mb-3 fw-bold" style="color: ${textColor};">${title}</h4>
                                <p class="text-muted mb-4" style="font-size: 1rem; line-height: 1.6;">${message}</p>
                                <button type="button" class="btn ${btnColor} px-5 py-2 rounded-pill shadow-sm"
                                        data-bs-dismiss="modal" style="min-width: 120px;">
                                    <i class="bi bi-check-lg me-1"></i>Tamam
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            $('body').append(modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('modernAlertModal'));
            modal.show();
            
            $('#modernAlertModal').on('hidden.bs.modal', function() {
                $(this).remove();
            });
        }

        // Drag & Drop
        let draggedSessionId = null;
        let draggedElement = null;

        function initializeDragAndDrop() {
            if (isStudent) return;

            $(document).on('mouseenter', '.study-session', function() {
                if (!isStudent && !isTeacher) {
                    $(this).attr('draggable', 'true');
                    $(this).css('cursor', 'move');
                }
            });

            $(document).on('dragstart', '.study-session', function(e) {
                draggedElement = $(this);
                draggedSessionId = $(this).data('session-id');
                $(this).addClass('opacity-50');
                e.originalEvent.dataTransfer.effectAllowed = 'move';
            });

            $(document).on('dragend', '.study-session', function(e) {
                $(this).removeClass('opacity-50');
            });

            $(document).on('dragover', '.calendar-cell', function(e) {
                e.preventDefault();
                e.originalEvent.dataTransfer.dropEffect = 'move';
                $(this).addClass('bg-primary bg-opacity-10');
            });

            $(document).on('dragleave', '.calendar-cell', function(e) {
                $(this).removeClass('bg-primary bg-opacity-10');
            });

            let pendingMove = null;
            
            $(document).on('drop', '.calendar-cell', function(e) {
                e.preventDefault();
                $(this).removeClass('bg-primary bg-opacity-10');

                if (!draggedSessionId) return;

                const newDate = $(this).data('date');
                const newTimeSlotId = $(this).data('time-slot');

                pendingMove = {
                    sessionId: draggedSessionId,
                    newDate: newDate,
                    newTimeSlotId: newTimeSlotId
                };

                $('#moveConfirmModal').modal('show');

                draggedSessionId = null;
                draggedElement = null;
            });

            $('#confirmMoveBtn').on('click', function() {
                if (pendingMove) {
                    moveStudySession(pendingMove.sessionId, pendingMove.newDate, pendingMove.newTimeSlotId);
                    pendingMove = null;
                }
                $('#moveConfirmModal').modal('hide');
            });

            $('#moveConfirmModal').on('hidden.bs.modal', function() {
                pendingMove = null;
            });
        }

        function moveStudySession(sessionId, newDate, newTimeSlotId) {
            $.ajax({
                url: '/StudySession/MoveSession',
                type: 'POST',
                headers: {
                    'X-CSRF-TOKEN': $('input[name="__RequestVerificationToken"]').val()
                },
                data: {
                    sessionId: sessionId,
                    newDate: newDate,
                    newTimeSlotId: newTimeSlotId
                },
                success: function(response) {
                    if (response.success) {
                        showNotification('success', 'Etüt başarıyla taşındı!');
                        loadWeeklyCalendar();
                    } else {
                        showNotification('danger', response.message || 'Etüt taşınamadı.');
                    }
                },
                error: function() {
                    showNotification('danger', 'Bir hata oluştu.');
                }
            });
        }

        $(document).ready(function() {
            initializeDragAndDrop();
        });
    </script>
}

<style>
    /* Modern Calendar Enhancements */
    
    /* Disable button growth animations */
    .add-session-btn,
    .add-session-btn:hover,
    .add-session-btn:active,
    .study-session .btn,
    .study-session .btn:hover,
    .study-session .btn:active,
    .melody-btn-primary,
    .melody-btn-primary:hover,
    .melody-btn-primary:active,
    .melody-btn-icon,
    .melody-btn-icon:hover,
    .melody-btn-icon:active {
        transform: none !important;
    }
    
    /* Fix for action buttons in sessions */
    .study-session .btn-sm {
        min-width: 28px;
        height: 28px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        font-size: 0.75rem;
    }
    
    /* Success button - modern style */
    .study-session .btn-outline-success {
        background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        color: white;
        border: none;
        box-shadow: 0 2px 6px rgba(16, 185, 129, 0.25);
    }
    
    .study-session .btn-outline-success:hover:not(:disabled) {
        background: linear-gradient(135deg, #34d399 0%, #6ee7b7 100%);
        box-shadow: 0 4px 10px rgba(16, 185, 129, 0.35);
    }
    
    .study-session .btn-outline-success:disabled {
        background: rgba(16, 185, 129, 0.3);
        opacity: 0.5;
    }
    
    /* Danger button - modern style */
    .study-session .btn-outline-danger {
        background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
        color: white;
        border: none;
        box-shadow: 0 2px 6px rgba(239, 68, 68, 0.25);
    }
    
    .study-session .btn-outline-danger:hover:not(:disabled) {
        background: linear-gradient(135deg, #f87171 0%, #fca5a5 100%);
        box-shadow: 0 4px 10px rgba(239, 68, 68, 0.35);
    }
    
    .study-session .btn-outline-danger:disabled {
        background: rgba(239, 68, 68, 0.3);
        opacity: 0.5;
    }
    
    /* Delete button - modern style */
    .study-session .btn-outline-secondary {
        background: rgba(148, 163, 184, 0.15);
        color: #64748b;
        border: 1px solid rgba(148, 163, 184, 0.2);
    }
    
    .study-session .btn-outline-secondary:hover {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border-color: transparent;
        box-shadow: 0 2px 6px rgba(239, 68, 68, 0.25);
    }
</style>

<div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer" style="z-index: 1080;"></div>
